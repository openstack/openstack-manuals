     <section xmlns="http://docbook.org/ns/docbook"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    version="5.0" xml:id="s-glance-api">
        <info>
          <title>Highly available OpenStack Image API</title>
        </info>
        <simpara>OpenStack Image Service offers a service for discovering, registering, and retrieving virtual machine images.
To make the OpenStack Image API service highly available in active / passive mode, you must:</simpara>
        <itemizedlist>
          <listitem>
            <simpara>
Configure OpenStack Image to listen on the VIP address.
</simpara>
          </listitem>
          <listitem>
            <simpara>
Manage OpenStack Image API daemon with the Pacemaker cluster manager.
</simpara>
          </listitem>
          <listitem>
            <simpara>
Configure OpenStack services to use this IP address.
</simpara>
          </listitem>
        </itemizedlist>
        <note>
          <simpara>Here is the <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://docs.openstack.org/trunk/install-guide/install/apt/content/ch_installing-openstack-image.html">documentation</link> for installing OpenStack Image API service.</simpara>
        </note>
        <section xml:id="_add_openstack_image_api_resource_to_pacemaker">
          <info>
            <title>Add OpenStack Image API resource to Pacemaker</title>
          </info>
          <simpara>First of all, you need to download the resource agent to your system:</simpara>
          <screen>cd /usr/lib/ocf/resource.d/openstack
wget https://raw.github.com/madkiss/openstack-resource-agents/master/ocf/glance-api
chmod a+rx *</screen>
          <simpara>You can now add the Pacemaker configuration for
OpenStack Image API resource. Connect to the Pacemaker cluster with <literal>crm
configure</literal>, and add the following cluster resources:</simpara>
          <screen>primitive p_glance-api ocf:openstack:glance-api \
    params config="/etc/glance/glance-api.conf" os_password="secrete" os_username="admin" os_tenant_name="admin" os_auth_url="http://192.168.42.103:5000/v2.0/" \
    op monitor interval="30s" timeout="30s"</screen>
          <simpara>This configuration creates</simpara>
          <itemizedlist>
            <listitem>
              <simpara><literal>p_glance-api</literal>, a resource for manage OpenStack Image API service
</simpara>
            </listitem>
          </itemizedlist>
          <simpara><literal>crm configure</literal> supports batch input, so you may copy and paste the
above into your live pacemaker configuration, and then make changes as
required. For example, you may enter <literal>edit p_ip_glance-api</literal> from the
<literal>crm configure</literal> menu and edit the resource to match your preferred
virtual IP address.</simpara>
          <simpara>Once completed, commit your configuration changes by entering <literal>commit</literal>
from the <literal>crm configure</literal> menu. Pacemaker will then start the OpenStack Image API
service, and its dependent resources, on one of your nodes.</simpara>
        </section>
        <section xml:id="_configure_openstack_image_service_api">
          <info>
            <title>Configure OpenStack Image Service API</title>
          </info>
          <simpara>Edit <literal>/etc/glance/glance-api.conf</literal>:</simpara>
          <screen># We have to use MySQL connection to store data:
sql_connection=mysql://glance:password@192.168.42.101/glance

# We bind OpenStack Image API to the VIP:
bind_host = 192.168.42.103

# Connect to OpenStack Image Registry service:
registry_host = 192.168.42.103

# We send notifications to High Available RabbitMQ:
notifier_strategy = rabbit
rabbit_host = 192.168.42.102</screen>
        </section>
        <section xml:id="_configure_openstack_services_to_use_high_available_openstack_image_api">
          <info>
            <title>Configure OpenStack services to use high available OpenStack Image API</title>
          </info>
          <simpara>Your OpenStack services must now point their OpenStack Image API configuration to
the highly available, virtual cluster IP address — rather than an
OpenStack Image API server’s physical IP address as you normally would.</simpara>
          <simpara>For OpenStack Compute, for example, if your OpenStack Image API service IP address is
192.168.42.104 as in the configuration explained here, you would use
the following line in your <literal>nova.conf</literal> file:</simpara>
          <screen>glance_api_servers = 192.168.42.103</screen>
          <simpara>You must also create the OpenStack Image API endpoint with this IP.</simpara>
          <note>
            <simpara>If you are using both private and public IP addresses, you should create two Virtual IP addresses and define your endpoint like this:</simpara>
          </note>
          <screen>keystone endpoint-create --region $KEYSTONE_REGION --service-id $service-id --publicurl 'http://PUBLIC_VIP:9292' --adminurl 'http://192.168.42.103:9292' --internalurl 'http://192.168.42.103:9292'</screen>
        </section>
      </section>
